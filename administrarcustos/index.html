rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper functions (Funções Auxiliares) ---
    function isAdmin() {
      // Verifica se o usuário está logado e se o documento do usuário possui isAdmin: true
      // Isso requer que o documento 'users/{request.auth.uid}' exista.
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    function isSignedIn() {
      // Verifica se o usuário está autenticado
      return request.auth != null;
    }

    function isEmailVerified() {
      // Verifica se o e-mail do usuário autenticado foi verificado
      return isSignedIn() && request.auth.token.email_verified == true;
    }

    function isOwner(userId) {
      // Verifica se o usuário autenticado é o proprietário do documento (baseado no UID)
      return isEmailVerified() && request.auth.uid == userId;
    }

    // --- Regras para Coleções ---

    // Coleção 'users' (Perfis de Usuários, onde o isAdmin é verificado)
    // O ID do documento 'userId' DEVE ser o UID do Firebase Auth.
    match /users/{userId} {
      // Permite criar o próprio perfil, se for o owner e não estiver tentando se tornar admin.
      allow create: if isOwner(userId) && !("isAdmin" in request.resource.data);
      // Permite leitura para o próprio usuário ou para um admin.
      // Permite atualização para o próprio usuário (não pode mudar isAdmin) ou para um admin.
      allow read, update: if isOwner(userId) || isAdmin();
    }

    // Coleção 'clients' (Perfis Detalhados do Cliente, vinculados ao UID do Google)
    // O ID do documento 'clientId' DEVE ser o UID do Firebase Auth.
    match /clients/{clientId} {
      // Permite criar um perfil de cliente apenas se:
      // 1. O usuário estiver logado E o e-mail verificado.
      // 2. O ID do documento que está sendo criado for o UID do usuário logado.
      // 3. O 'uidGoogle' no recurso também corresponder ao UID do usuário logado.
      allow create: if isEmailVerified() && request.auth.uid == clientId && request.resource.data.uidGoogle == request.auth.uid;

      // Permite ler/atualizar o próprio perfil de cliente, se o e-mail estiver verificado.
      // Admins também podem ler/atualizar qualquer perfil de cliente.
      allow read, update: if (isEmailVerified() && request.auth.uid == clientId) || isAdmin();
    }

    // Coleção 'clientPhones' (Telefones dos Clientes)
    match /clientPhones/{phoneId} {
      // Permite criar um registro de telefone se:
      // 1. O usuário estiver logado E o e-mail verificado.
      // 2. O 'clientId' no recurso que está sendo criado corresponder ao UID do usuário logado.
      allow create: if isEmailVerified() && request.resource.data.clientId == request.auth.uid;

      // Permite ler/atualizar/deletar um registro de telefone apenas se:
      // 1. O e-mail do usuário estiver verificado.
      // 2. O 'clientId' no documento existente corresponder ao UID do usuário logado.
      // Admins também podem fazer tudo.
      allow read, update, delete: if (isEmailVerified() && resource.data.clientId == request.auth.uid) || isAdmin();
    }

    // Coleção 'clientEmails' (Emails Adicionais dos Clientes, além do de autenticação)
    match /clientEmails/{emailId} {
      // Permite criar um registro de e-mail se:
      // 1. O usuário estiver logado E o e-mail verificado.
      // 2. O 'clientId' no recurso que está sendo criado corresponder ao UID do usuário logado.
      allow create: if isEmailVerified() && request.resource.data.clientId == request.auth.uid;

      // Permite ler/atualizar/deletar um registro de e-mail apenas se:
      // 1. O e-mail do usuário estiver verificado.
      // 2. O 'clientId' no documento existente corresponder ao UID do usuário logado.
      // Admins também podem fazer tudo.
      allow read, update, delete: if (isEmailVerified() && resource.data.clientId == request.auth.uid) || isAdmin();
    }

    // Coleção 'clientHistory' (Histórico de Alterações dos Clientes)
    match /clientHistory/{historyId} {
      // Permite criar um registro de histórico se o usuário estiver logado e o e-mail verificado.
      // É importante que o 'editorId' ou 'clientId' no recurso corresponda ao UID logado, se relevante.
      allow create: if isEmailVerified();
      // Permite ler o histórico se for do próprio cliente ou se for um admin.
      allow read: if (isEmailVerified() && resource.data.clientId == request.auth.uid) || isAdmin();
      // Admins podem atualizar/deletar registros de histórico (raro, mas possível para correção).
      allow update, delete: if isAdmin();
    }

    // Coleção 'minhapersona'
    match /minhapersona/{documentId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn()
                      && request.resource.data.name is string
                      && request.resource.data.name.size() > 0;
      allow update, delete: if (isOwner(resource.data.authorUid) && isEmailVerified()) || isAdmin();
    }

    // Coleção 'articles' (Se ainda estiver em uso - leitura pública, escrita apenas para admin)
    match /articles/{documentId} {
      allow read: if true; // Todos podem ler
      allow create: if isEmailVerified() // Apenas usuários com email verificado podem criar
                      && request.resource.data.title is string
                      && request.resource.data.content is string
                      && request.resource.data.title.size() > 0
                      && request.resource.data.content.size() > 0;
      allow update, delete: if isAdmin(); // Apenas admin pode atualizar/deletar
    }

    // Coleção 'articlesdoc' (Principal para Artigos - Leitura pública, criação/atualização/deleção para o autor ou admin)
    match /articlesdoc/{articleDocId} {
      allow read: if true; // Todos podem ler
      allow create: if isEmailVerified()
                      && request.resource.data.title is string
                      && request.resource.data.title.size() > 0;
      allow update, delete: if (isOwner(resource.data.userId) && isEmailVerified()) || isAdmin();
    }

    // Coleção 'articlesdoc_history' (Histórico de Edições de Artigos)
    match /articlesdoc_history/{historyEntryId} {
      allow read: if isSignedIn();
      allow create: if isEmailVerified(); // Apenas usuários com email verificado podem criar
      allow update, delete: if isAdmin();
    }

    // Coleção 'materials'
    match /materials/{materialId} {
      allow read: if isSignedIn();
      allow create: if isEmailVerified()
                      && request.resource.data.name is string
                      && request.resource.data.url is string
                      && request.resource.data.name.size() > 0;
      allow update, delete: if (isOwner(resource.data.authorUid) && isEmailVerified()) || isAdmin();
    }

    // Coleção 'settings' (para configuracoes.html - Apenas Admin)
    match /settings/{documentId} {
      allow read, write: if isAdmin();
    }

    // Coleção 'views' (para estatisticas.html - Apenas Admin pode ler. Criação pode ser pública ou restrita)
    match /views/{viewId} {
      allow read: if isAdmin();
      // Exemplo: Permitir que qualquer um crie uma 'view' (visita) - CUIDADO com abuso
      // allow create: if true;
    }

    // Coleção aninhada 'WZZM/paginashtmlweb/paginas'
    match /WZZM/paginashtmlweb/paginas/{pageId} {
      allow read: if true;
      allow write: if isAdmin()
                      && request.resource.data.htmlContent is string
                      && request.resource.data.htmlContent.size() > 0;
    }

    // Coleção 'userteatcher' (Professores - Leitura para todos logados, CRUD para Admin)
    match /userteatcher/{teacherId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // Coleção 'reports' (Denúncias - Criação para o relator logado/verificado, CRUD para Admin)
    match /reports/{reportId} {
      allow create: if isEmailVerified()
                      && request.resource.data.description is string
                      && request.resource.data.description.size() > 0
                      && request.resource.data.contentId is string
                      && request.resource.data.contentId.size() > 0 // Adicionei validação de tamanho
                      && request.resource.data.reporterUid == request.auth.uid;
      allow read, update, delete: if isAdmin();
    }

    // Coleção 'userEmails' (Mensagens da Caixa de Entrada do Usuário)
    match /userEmails/{messageId} {
      // Permite leitura se for o recipiente, o remetente ou um admin.
      allow read: if (isEmailVerified() && (isOwner(resource.data.recipientId) || isOwner(resource.data.senderId))) || isAdmin();
      // Permite criação se for logado/verificado, o remetente for o próprio usuário, e os campos obrigatórios existirem.
      allow create: if isEmailVerified()
                      && request.resource.data.recipientId is string
                      && request.resource.data.senderId is string
                      && request.resource.data.subject is string
                      && request.resource.data.message is string
                      && request.resource.data.recipientId != request.resource.data.senderId
                      && request.resource.data.senderId == request.auth.uid;
      // Permite atualização pelo recipiente ou admin (para marcar como lido, por exemplo).
      allow update: if (isEmailVerified() && isOwner(resource.data.recipientId)) || isAdmin();
      // Permite deletar apenas por admin.
      allow delete: if isAdmin();
    }

    // Coleção 'wikizero' (Notícias/Matérias - Leitura pública, CRUD para o autor ou admin)
    match /wikizero/{newsId} {
      allow read: if true;
      allow create: if isEmailVerified()
                      && request.resource.data.title is string
                      && request.resource.data.description is string
                      && request.resource.data.authorUid is string
                      && request.resource.data.title.size() > 0
                      && request.resource.data.description.size() > 0
                      && request.resource.data.authorUid == request.auth.uid;
      allow update, delete: if (isOwner(resource.data.authorUid) && isEmailVerified()) || isAdmin();
    }

    // Coleção 'news' (Notícias/Matérias do editordenoticias.html - Leitura pública, CRUD para o autor ou admin)
    match /news/{newsId} {
      allow read: if true;
      allow create: if isEmailVerified()
                      && request.resource.data.title is string
                      && request.resource.data.description is string
                      && request.resource.data.category is string
                      && request.resource.data.authorUid is string
                      && request.resource.data.title.size() > 0
                      && request.resource.data.description.size() > 0
                      && request.resource.data.category.size() > 0
                      && request.resource.data.authorUid == request.auth.uid;
      allow update, delete: if (isOwner(resource.data.authorUid) && isEmailVerified()) || isAdmin();
    }

    // Subcoleção 'docoffice/{userId}/documents'
    // O ID do documento pai 'userId' DEVE ser o UID do Firebase Auth.
    match /docoffice/{userId}/documents/{documentId} {
      allow read: if isOwner(userId);
      allow create, update: if isOwner(userId)
                              && request.resource.data.title is string
                              && request.resource.data.content is string
                              && request.resource.data.title.size() > 0
                              && request.resource.data.content.size() > 0;
      allow delete: if isOwner(userId);
    }

    // Coleção 'forums' (Nível Superior - Leitura pública, criação/atualização/deleção para o autor ou admin)
    match /forums/{forumId} {
      allow read: if true; // Todos podem ler os fóruns (público)
      allow create: if isEmailVerified()
                        && request.resource.data.subject is string
                        && request.resource.data.subject.size() > 0
                        && request.resource.data.authorUid == request.auth.uid;
      allow update, delete: if (isOwner(resource.data.authorUid) && isEmailVerified()) || isAdmin();

      // Subcoleção 'messages' dentro de um fórum (Leitura pública, criação/atualização/deleção para o autor ou admin)
      match /messages/{messageId} {
        allow read: if true; // Todos podem ler as mensagens de um fórum
        allow create: if isEmailVerified()
                          && request.resource.data.content is string
                          && request.resource.data.content.size() > 0
                          && request.resource.data.userId == request.auth.uid;
        allow update, delete: if (isOwner(resource.data.userId) && isEmailVerified()) || isAdmin();
      }
    }

    // Coleção 'aplicativo' (Aplicativos de Usuários)
    match /aplicativo/{appId} {
      allow read: if isSignedIn(); // Apenas logados podem ler
      allow create: if isEmailVerified(); // Apenas logados com email verificado podem criar
      allow update, delete: if (isOwner(resource.data.criadorUID) && isEmailVerified()) || isAdmin(); // Apenas o criador ou admin podem atualizar/deletar
    }

    // Coleção 'materia' (Matérias - Leitura pública, criação para logados, sem update/delete específico)
    match /materia/{materiaId} {
      allow create: if isSignedIn(); // Permite a criação de matérias para usuários logados
      allow read: if true; // Permite a leitura de todas as matérias por qualquer um (até não logado)
      // Você pode escolher entre o criador ou apenas admin para update/delete:
      allow update, delete: if (isOwner(resource.data.uidUsuario) && isEmailVerified()) || isAdmin(); // Permite o criador ou admin
    }

    // Coleção 'financialData' (Dados Financeiros mensais - Leitura pública, escrita apenas para admin)
    match /financialData/{monthYear} {
      allow read: if true; // Qualquer um pode ler os dados de transparência
      allow write: if isAdmin(); // Apenas admins podem criar/atualizar/deletar
    }

    // Coleção 'invoices' (Notas Fiscais - Leitura pública, CRUD apenas para admin)
    match /invoices/{invoiceId} {
      allow read: if true; // Qualquer um pode ler as notas fiscais
      allow write: if isAdmin(); // Apenas admins podem criar/atualizar/deletar
    }

    // --- Regra Padrão (Nega tudo o que não foi explicitamente permitido) ---
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transparência Financeira - WZZM</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 20px;
      box-sizing: border-box;
    }
    .mdl-card {
      width: 100%;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
    }
    .mdl-list__item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    input.mdl-textfield__input {
      padding: 4px 8px;
      font-size: 1em;
    }
    .summary-card {
      margin-top: 30px;
      padding: 20px;
      background-color: #e8eaf6;
      color: #3f51b5;
      font-size: 1.2em;
      font-weight: bold;
      text-align: center;
      border-radius: 4px;
    }
    .summary-card.positive {
      background-color: #e0f2f1;
      color: #00796b;
    }
    .summary-card.negative {
      background-color: #ffebee;
      color: #d32f2f;
    }
    .status-message {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      text-align: center;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="mdl-card mdl-shadow--2dp">
  <div class="mdl-card__title mdl-card--expand">
    <h2 class="mdl-card__title-text">Transparência Financeira WZZM</h2>
  </div>
  <div class="mdl-card__supporting-text">
    <p>O projeto WZZM opera sem fins lucrativos e depende de doações para cobrir seus custos de infraestrutura.</p>

    <div id="statusMessage" class="status-message" style="display: none;"></div>

    <h3>Resumo Mensal (<span id="currentMonthYear"></span>)</h3>
    <ul class="mdl-list">
      <li class="mdl-list__item">
        <span class="mdl-list__item-primary-content">Doações Recebidas:</span>
        <input type="number" id="inputTotalDonations" class="mdl-textfield__input" />
      </li>
      <li class="mdl-list__item">
        <span class="mdl-list__item-primary-content">Custo Firebase (Previsão):</span>
        <input type="number" id="inputCostFirebase" class="mdl-textfield__input" />
      </li>
      <li class="mdl-list__item">
        <span class="mdl-list__item-primary-content">Custo Google Workspace (Previsão):</span>
        <input type="number" id="inputCostWorkspace" class="mdl-textfield__input" />
      </li>
    </ul>

    <div id="balanceCard" class="summary-card">
      Saldo Atual: <span id="currentBalance">R$ 0,00</span>
    </div>

    <div style="text-align: center; margin-top: 20px;">
      <button class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" onclick="salvarDadosFinanceiros()">Salvar Alterações</button>
    </div>
  </div>
</div>

<script src="https://code.getmdl.io/1.3.0/material.min.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
    authDomain: "wzzm-ce3fc.firebaseapp.com",
    projectId: "wzzm-ce3fc",
    storageBucket: "wzzm-ce3fc.appspot.com",
    messagingSenderId: "249427877153",
    appId: "1:249427877153:web:0e4297294794a5aadeb260",
    measurementId: "G-PLKNZNFCQ8"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const firestore = firebase.firestore();

  const inputTotalDonations = document.getElementById('inputTotalDonations');
  const inputCostFirebase = document.getElementById('inputCostFirebase');
  const inputCostWorkspace = document.getElementById('inputCostWorkspace');
  const currentBalanceEl = document.getElementById('currentBalance');
  const balanceCardEl = document.getElementById('balanceCard');
  const currentMonthYearEl = document.getElementById('currentMonthYear');
  const statusMessageDiv = document.getElementById('statusMessage');

  function formatCurrency(value) {
    return `R$ ${value.toFixed(2).replace('.', ',')}`;
  }

  async function loadFinancialData() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    const monthYearId = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;
    const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    currentMonthYearEl.textContent = `${monthNames[now.getMonth()]} de ${currentYear}`;

    try {
      const docRef = firestore.collection('financialData').doc(monthYearId);
      const doc = await docRef.get();

      let total = 0, firebaseCost = 0, workspaceCost = 0, statusText = "";

      if (doc.exists) {
        const data = doc.data();
        total = data.totalDonations || 0;
        firebaseCost = data.firebaseCost || 0;
        workspaceCost = data.workspaceCost || 0;
        statusText = data.statusMessage || "";
      }

      inputTotalDonations.value = total;
      inputCostFirebase.value = firebaseCost;
      inputCostWorkspace.value = workspaceCost;

      const balance = total - (firebaseCost + workspaceCost);
      currentBalanceEl.textContent = formatCurrency(balance);

      if (balance >= 0) {
        balanceCardEl.classList.add('positive');
        balanceCardEl.classList.remove('negative');
      } else {
        balanceCardEl.classList.add('negative');
        balanceCardEl.classList.remove('positive');
      }

      if (statusText) {
        statusMessageDiv.textContent = statusText;
        statusMessageDiv.style.display = 'block';
      } else {
        statusMessageDiv.style.display = 'none';
      }

    } catch (e) {
      console.error("Erro ao carregar dados:", e);
      statusMessageDiv.textContent = "Erro ao carregar dados financeiros.";
      statusMessageDiv.style.display = 'block';
    }
  }

  async function salvarDadosFinanceiros() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1;
    const currentYear = now.getFullYear();
    const monthYearId = `${currentYear}-${String(currentMonth).padStart(2, '0')}`;

    const totalDonations = parseFloat(inputTotalDonations.value) || 0;
    const firebaseCost = parseFloat(inputCostFirebase.value) || 0;
    const workspaceCost = parseFloat(inputCostWorkspace.value) || 0;

    try {
      await firestore.collection("financialData").doc(monthYearId).set({
        totalDonations,
        firebaseCost,
        workspaceCost
      }, { merge: true });

      alert("Dados atualizados com sucesso!");
      loadFinancialData();
    } catch (e) {
      console.error("Erro ao salvar dados:", e);
      alert("Erro ao salvar os dados.");
    }
  }

  document.addEventListener('DOMContentLoaded', loadFinancialData);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração de Custos</title>
    <style>
        /* Estilos básicos para o exemplo */
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #0056b3;
        }
        form {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="number"],
        input[type="text"],
        button {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #218838;
        }
        #financialDataDisplay {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        #currentUserStatus {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Administração de Custos</h1>

        <div id="currentUserStatus">
            <p>Status do Usuário: <span id="userStatus">Não Autenticado</span></p>
            <p>Email: <span id="userEmail">N/A</span></p>
            <p>Admin: <span id="isAdminStatus">Não</span></p>
            <button id="signInButton" style="display: none;">Fazer Login (Exemplo)</button>
            <button id="signOutButton" style="display: none;">Sair</button>
        </div>

        <div id="adminContent" style="display: none;">
            <h2>Adicionar/Atualizar Dados Financeiros</h2>
            <form id="financialDataForm">
                <label for="currentMonthYear">Mês/Ano:</label>
                <input type="text" id="currentMonthYear" readonly>

                <label for="monthlyCost">Custo Mensal:</label>
                <input type="number" id="monthlyCost" placeholder="Ex: 1500.50" step="0.01" required>

                <label for="monthlyRevenue">Receita Mensal:</label>
                <input type="number" id="monthlyRevenue" placeholder="Ex: 2000.00" step="0.01" required>

                <button type="submit">Salvar Dados Financeiros</button>
            </form>

            <h2>Dados Financeiros Atuais</h2>
            <div id="financialDataDisplay">
                Carregando dados...
            </div>
            <p class="error-message" id="financialDataError"></p>
        </div>

        <div id="loadingMessage">
            <p>Carregando Firebase e verificando autenticação...</p>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

    <script>
        // Substitua pelas suas credenciais do Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Referências aos elementos HTML
        const userStatusSpan = document.getElementById('userStatus');
        const userEmailSpan = document.getElementById('userEmail');
        const isAdminStatusSpan = document.getElementById('isAdminStatus');
        const signInButton = document.getElementById('signInButton');
        const signOutButton = document.getElementById('signOutButton');
        const adminContentDiv = document.getElementById('adminContent');
        const loadingMessageDiv = document.getElementById('loadingMessage');
        const currentMonthYearInput = document.getElementById('currentMonthYear');
        const financialDataForm = document.getElementById('financialDataForm');
        const financialDataDisplay = document.getElementById('financialDataDisplay');
        const financialDataError = document.getElementById('financialDataError');

        let currentUser = null;
        let currentUserIsAdmin = false;

        // --- Funções Auxiliares ---

        /**
         * Gera o ID do mês/ano atual no formato YYYY-MM.
         * @returns {string} O ID do mês/ano.
         */
        function getCurrentMonthYearId() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0'); // Mês de 01 a 12
            return `${year}-${month}`;
        }

        /**
         * Verifica se o usuário logado é um administrador.
         * Assume que existe uma coleção 'users' e um campo 'isAdmin: true' no documento do usuário.
         * @returns {Promise<boolean>} True se for admin, false caso contrário.
         */
        async function checkAdminStatus() {
            if (!currentUser) {
                return false;
            }
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                return userDoc.exists && userDoc.data().isAdmin === true;
            } catch (error) {
                console.error("Erro ao verificar status de admin:", error);
                return false;
            }
        }

        /**
         * Carrega e aplica CSS personalizado de aplicativos do usuário.
         * Este é um exemplo. Adapte com base na sua estrutura de dados.
         */
        async function loadAndApplyUserAppsCSS() {
            console.log("Tentando carregar/aplicar CSS de aplicativos do usuário...");
            try {
                // EX: Se o CSS está em um documento fixo na coleção 'aplicativo'
                // Ou se você armazena CSS por usuário, você precisará do UID aqui
                const docRef = db.collection('aplicativo').doc('meuAppCSSGlobal'); // Substitua pelo ID real do seu documento CSS
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    const cssContent = docSnap.data().cssContent; // Supondo que o campo se chama 'cssContent'
                    if (cssContent) {
                        let styleTag = document.getElementById('userAppStyle');
                        if (!styleTag) {
                            styleTag = document.createElement('style');
                            styleTag.id = 'userAppStyle';
                            document.head.appendChild(styleTag);
                        }
                        styleTag.innerHTML = cssContent;
                        console.log("CSS de aplicativos do usuário aplicado com sucesso.");
                    }
                } else {
                    console.log("Documento de CSS de aplicativos não encontrado.");
                }
            } catch (error) {
                console.error("Erro ao carregar/aplicar CSS de aplicativos do usuário:", error);
                // Exiba uma mensagem de erro na UI se necessário
                // document.getElementById('someErrorDiv').innerText = 'Erro ao carregar estilos personalizados.';
            }
        }


        /**
         * Carrega os dados financeiros do mês atual.
         */
        async function loadCurrentFinancialData() {
            financialDataError.textContent = ''; // Limpa mensagens de erro anteriores
            financialDataDisplay.innerHTML = 'Carregando dados...';

            const monthYearId = getCurrentMonthYearId();
            currentMonthYearInput.value = monthYearId; // Preenche o input do formulário

            if (!monthYearId) {
                const errorMessage = "Erro: ID do mês/ano está vazio. Não foi possível carregar dados financeiros.";
                console.error(errorMessage);
                financialDataError.textContent = errorMessage;
                financialDataDisplay.innerHTML = 'Nenhum dado disponível.';
                return;
            }

            try {
                const docRef = db.collection('financialData').doc(monthYearId);
                const docSnap = await docRef.get();

                if (docSnap.exists) {
                    const data = docSnap.data();
                    financialDataDisplay.innerHTML = `
                        <p><strong>Custo Mensal:</strong> R$ ${data.monthlyCost ? data.monthlyCost.toFixed(2) : 'N/A'}</p>
                        <p><strong>Receita Mensal:</strong> R$ ${data.monthlyRevenue ? data.monthlyRevenue.toFixed(2) : 'N/A'}</p>
                        <p><strong>Última Atualização:</strong> ${data.updatedAt ? new Date(data.updatedAt.toDate()).toLocaleString() : 'N/A'}</p>
                    `;
                    // Preencher formulário para edição
                    document.getElementById('monthlyCost').value = data.monthlyCost || '';
                    document.getElementById('monthlyRevenue').value = data.monthlyRevenue || '';
                } else {
                    financialDataDisplay.innerHTML = 'Nenhum dado financeiro encontrado para o mês atual. Você pode adicionar um novo.';
                    // Limpar formulário se não houver dados
                    document.getElementById('monthlyCost').value = '';
                    document.getElementById('monthlyRevenue').value = '';
                }
            } catch (error) {
                console.error("Erro ao carregar dados financeiros:", error);
                financialDataError.textContent = `Erro ao carregar dados financeiros: ${error.message}`;
                financialDataDisplay.innerHTML = 'Erro ao carregar dados.';
            }
        }

        /**
         * Lida com o envio do formulário de dados financeiros.
         */
        financialDataForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser || !currentUserIsAdmin) {
                alert("Você não tem permissão para salvar dados financeiros.");
                return;
            }

            const monthYearId = currentMonthYearInput.value;
            const monthlyCost = parseFloat(document.getElementById('monthlyCost').value);
            const monthlyRevenue = parseFloat(document.getElementById('monthlyRevenue').value);

            if (isNaN(monthlyCost) || isNaN(monthlyRevenue)) {
                alert("Por favor, insira valores numéricos válidos para Custo e Receita.");
                return;
            }

            try {
                const docRef = db.collection('financialData').doc(monthYearId);
                const dataToSave = {
                    monthlyCost: monthlyCost,
                    monthlyRevenue: monthlyRevenue,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    editorUid: currentUser.uid
                };

                // Verifica se o documento já existe para decidir entre set ou update
                const docSnap = await docRef.get();
                if (docSnap.exists) {
                    await docRef.update(dataToSave);
                    console.log("Dados financeiros atualizados com sucesso!");
                } else {
                    await docRef.set(dataToSave);
                    console.log("Novos dados financeiros criados com sucesso!");
                }

                alert("Dados financeiros salvos com sucesso!");
                loadCurrentFinancialData(); // Recarrega os dados para exibição
            } catch (error) {
                console.error("Erro ao salvar dados financeiros:", error);
                alert(`Erro ao salvar dados financeiros: ${error.message}`);
            }
        });

        // --- Gerenciamento de Autenticação ---

        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            loadingMessageDiv.style.display = 'none'; // Esconde a mensagem de carregamento

            if (user) {
                userStatusSpan.textContent = 'Autenticado';
                userEmailSpan.textContent = user.email;
                signOutButton.style.display = 'inline-block';
                signInButton.style.display = 'none';

                // Verifica se o email do usuário é verificado
                if (user.emailVerified) {
                    console.log("Email verificado.");
                    // Tenta atualizar o lastLoginAt do usuário no Firestore
                    try {
                        await db.collection('users').doc(user.uid).update({
                            lastLoginAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log("Perfil de usuário atualizado no Firestore (lastLoginAt).");
                    } catch (error) {
                        console.error("Erro ao atualizar lastLoginAt:", error);
                        // Isso pode acontecer se o documento 'users/{uid}' não existir
                        // Ou se as regras não permitirem a escrita
                    }

                    // Verifica o status de admin
                    currentUserIsAdmin = await checkAdminStatus();
                    isAdminStatusSpan.textContent = currentUserIsAdmin ? 'Sim' : 'Não';

                    if (currentUserIsAdmin) {
                        adminContentDiv.style.display = 'block'; // Mostra conteúdo de admin
                        loadCurrentFinancialData(); // Carrega os dados financeiros se for admin
                    } else {
                        adminContentDiv.style.display = 'none'; // Esconde se não for admin
                        financialDataDisplay.innerHTML = 'Você não tem permissão para ver/editar dados financeiros.';
                    }

                    loadAndApplyUserAppsCSS(); // Tenta carregar o CSS para todos os usuários logados
                } else {
                    userStatusSpan.textContent = 'Autenticado (Email NÃO Verificado)';
                    isAdminStatusSpan.textContent = 'Não'; // Não é admin se email não for verificado (pela sua regra isEmailVerified)
                    adminContentDiv.style.display = 'none';
                    financialDataDisplay.innerHTML = 'Por favor, verifique seu e-mail para acessar os recursos.';
                    console.warn("Usuário logado, mas email não verificado.");
                    // Opcional: oferecer reenvio de e-mail de verificação
                }

            } else {
                userStatusSpan.textContent = 'Não Autenticado';
                userEmailSpan.textContent = 'N/A';
                isAdminStatusSpan.textContent = 'Não';
                signOutButton.style.display = 'none';
                signInButton.style.display = 'inline-block';
                adminContentDiv.style.display = 'none'; // Esconde o conteúdo de admin
                financialDataDisplay.innerHTML = 'Faça login para acessar os dados.';
            }
        });

        // --- Botões de Exemplo (Para teste, remova em produção ou use seu sistema de login real) ---
        signInButton.addEventListener('click', async () => {
            // Este é um exemplo simplificado de login ANÔNIMO para fins de teste.
            // Em um app real, você usaria login com email/senha, Google, etc.
            try {
                await auth.signInAnonymously();
                console.log("Usuário logado anonimamente (para teste).");
                alert("Login anônimo realizado. Lembre-se que você precisa de um usuário com email verificado e isAdmin: true no Firestore para ver o conteúdo de admin.");
            } catch (error) {
                console.error("Erro ao tentar login:", error);
                alert("Erro ao fazer login: " + error.message);
            }
        });

        signOutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                console.log("Usuário deslogado.");
                alert("Deslogado com sucesso!");
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                alert("Erro ao fazer logout: " + error.message);
            }
        });

        // Inicializa o input do mês/ano ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            currentMonthYearInput.value = getCurrentMonthYearId();
        });

    </script>
</body>
</html>

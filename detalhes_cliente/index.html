<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administração de Usuários</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            color: #0056b3;
        }
        form {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="email"],
        textarea,
        button {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #218838;
        }
        button.red {
            background-color: #dc3545;
        }
        button.red:hover {
            background-color: #c82333;
        }
        #userDetails, #adminAccessDenied {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        #userDetails p {
            margin-bottom: 5px;
        }
        .error-message {
            color: red;
            font-weight: bold;
            margin-top: 10px;
        }
        .success-message {
            color: green;
            font-weight: bold;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Administração de Usuários</h1>

        <div id="adminAccessDenied" style="display: none;">
            <p>Acesso negado. Você não tem permissão de administrador para esta página.</p>
            <p>Por favor, <a href="../login.html">faça login como administrador</a>.</p>
        </div>

        <div id="adminContent" style="display: none;">
            <h2>Buscar Usuário por UID</h2>
            <form id="searchUserForm">
                <label for="searchUid">UID do Usuário:</label>
                <input type="text" id="searchUid" placeholder="Digite o UID do usuário" required>
                <button type="submit">Buscar Usuário</button>
            </form>
            <p class="error-message" id="searchError"></p>

            <hr>

            <div id="userDetails" style="display: none;">
                <h2>Informações do Usuário</h2>
                <p><strong>UID:</strong> <span id="userUidDisplay"></span></p>
                <p><strong>Email:</strong> <span id="userEmailDisplay"></span></p>
                <p><strong>Admin:</strong> <span id="userIsAdminDisplay"></span></p>
                <p><strong>Último Login:</strong> <span id="userLastLoginDisplay"></span></p>
                <p><strong>Banido:</strong> <span id="userIsBannedDisplay"></span></p>

                <form id="editUserForm">
                    <label for="userName">Nome:</label>
                    <input type="text" id="userName" required>

                    <label for="userProfilePictureUrl">URL da Imagem de Perfil:</label>
                    <input type="text" id="userProfilePictureUrl">

                    <label for="userMotivoBan">Motivo do Banimento:</label>
                    <textarea id="userMotivoBan" rows="3" placeholder="Motivo do banimento (obrigatório se banido)"></textarea>

                    <button type="submit">Salvar Alterações</button>
                    <button type="button" id="toggleBanButton" class="red">Banir Usuário</button>
                    <p class="error-message" id="editError"></p>
                    <p class="success-message" id="editSuccess"></p>
                </form>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>

    <script>
        // Substitua pelas suas credenciais do Firebase
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const functions = firebase.functions(); // Inicializa o Firebase Functions

        // Elementos HTML
        const adminAccessDeniedDiv = document.getElementById('adminAccessDenied');
        const adminContentDiv = document.getElementById('adminContent');
        const searchUserForm = document.getElementById('searchUserForm');
        const searchUidInput = document.getElementById('searchUid');
        const searchErrorDiv = document.getElementById('searchError');
        const userDetailsDiv = document.getElementById('userDetails');

        const userUidDisplay = document.getElementById('userUidDisplay');
        const userEmailDisplay = document.getElementById('userEmailDisplay');
        const userIsAdminDisplay = document.getElementById('userIsAdminDisplay');
        const userLastLoginDisplay = document.getElementById('userLastLoginDisplay');
        const userIsBannedDisplay = document.getElementById('userIsBannedDisplay');

        const editUserForm = document.getElementById('editUserForm');
        const userNameInput = document.getElementById('userName');
        const userProfilePictureUrlInput = document.getElementById('userProfilePictureUrl');
        const userMotivoBanInput = document.getElementById('userMotivoBan');
        const toggleBanButton = document.getElementById('toggleBanButton');
        const editErrorDiv = document.getElementById('editError');
        const editSuccessDiv = document.getElementById('editSuccess');

        let currentAdminUser = null;
        let selectedUserUid = null; // UID do usuário sendo editado
        let selectedUserIsBanned = false; // Estado de banimento do usuário selecionado

        // --- Funções Auxiliares ---

        /**
         * Verifica se o usuário logado é um administrador.
         * Assume que existe uma coleção 'users' e um campo 'isAdmin: true' no documento do usuário.
         * @returns {Promise<boolean>} True se for admin, false caso contrário.
         */
        async function checkAdminStatus(uid) {
            if (!uid) return false;
            try {
                const userDoc = await db.collection('users').doc(uid).get();
                return userDoc.exists && userDoc.data().isAdmin === true;
            } catch (error) {
                console.error("Erro ao verificar status de admin:", error);
                return false;
            }
        }

        /**
         * Limpa o formulário e a exibição de detalhes do usuário.
         */
        function clearUserDetails() {
            userDetailsDiv.style.display = 'none';
            userUidDisplay.textContent = '';
            userEmailDisplay.textContent = '';
            userIsAdminDisplay.textContent = '';
            userLastLoginDisplay.textContent = '';
            userIsBannedDisplay.textContent = '';
            userNameInput.value = '';
            userProfilePictureUrlInput.value = '';
            userMotivoBanInput.value = '';
            toggleBanButton.textContent = 'Banir Usuário';
            toggleBanButton.classList.add('red');
            editErrorDiv.textContent = '';
            editSuccessDiv.textContent = '';
            selectedUserUid = null;
            selectedUserIsBanned = false;
        }

        /**
         * Busca e exibe os detalhes de um usuário usando uma Cloud Function.
         * @param {string} uid O UID do usuário a ser buscado.
         */
        async function fetchUserDetails(uid) {
            clearUserDetails();
            searchErrorDiv.textContent = '';
            try {
                // Chama a Cloud Function para buscar os detalhes do usuário
                const getUserDetails = functions.httpsCallable('getUserDetailsAndToggleBan');
                const result = await getUserDetails({ uid: uid, action: 'getDetails' });
                const userData = result.data;

                if (userData && userData.uid) { // Verifica se a função retornou dados válidos
                    selectedUserUid = uid;
                    selectedUserIsBanned = userData.isBanned || false;

                    userUidDisplay.textContent = userData.uid;
                    userEmailDisplay.textContent = userData.email || 'N/A';
                    userIsAdminDisplay.textContent = userData.isAdmin ? 'Sim' : 'Não';
                    userLastLoginDisplay.textContent = userData.lastSignInTime ? new Date(userData.lastSignInTime).toLocaleString() : 'N/A';
                    userIsBannedDisplay.textContent = userData.isBanned ? 'Sim' : 'Não';

                    userNameInput.value = userData.displayName || '';
                    userProfilePictureUrlInput.value = userData.photoURL || '';
                    userMotivoBanInput.value = userData.motivoBan || '';

                    toggleBanButton.textContent = selectedUserIsBanned ? 'Desbanir Usuário' : 'Banir Usuário';
                    toggleBanButton.classList.toggle('red', !selectedUserIsBanned);

                    userDetailsDiv.style.display = 'block';
                } else {
                    searchErrorDiv.textContent = 'Usuário não encontrado ou erro ao buscar dados.';
                }
            } catch (error) {
                console.error("Erro ao buscar detalhes do usuário:", error);
                // Exibe a mensagem de erro da Cloud Function, se disponível
                searchErrorDiv.textContent = `Erro ao buscar usuário: ${error.message}`;
            }
        }

        // --- Event Listeners ---

        // Monitorar o estado de autenticação do administrador
        auth.onAuthStateChanged(async (user) => {
            currentAdminUser = user;
            if (user) {
                const isAdmin = await checkAdminStatus(user.uid);
                if (isAdmin) {
                    adminAccessDeniedDiv.style.display = 'none';
                    adminContentDiv.style.display = 'block';
                } else {
                    adminAccessDeniedDiv.style.display = 'block';
                    adminContentDiv.style.display = 'none';
                }
            } else {
                adminAccessDeniedDiv.style.display = 'block';
                adminContentDiv.style.display = 'none';
                clearUserDetails();
            }
        });

        // Formulário de busca de usuário
        searchUserForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const uidToSearch = searchUidInput.value.trim();
            if (uidToSearch) {
                fetchUserDetails(uidToSearch);
            } else {
                searchErrorDiv.textContent = 'Por favor, insira um UID para buscar.';
            }
        });

        // Formulário de edição de usuário
        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            editErrorDiv.textContent = '';
            editSuccessDiv.textContent = '';

            if (!currentAdminUser || !(await checkAdminStatus(currentAdminUser.uid))) {
                editErrorDiv.textContent = 'Você não tem permissão de administrador para salvar alterações.';
                return;
            }
            if (!selectedUserUid) {
                editErrorDiv.textContent = 'Nenhum usuário selecionado para edição.';
                return;
            }

            const newName = userNameInput.value.trim();
            const newProfilePictureUrl = userProfilePictureUrlInput.value.trim();
            // userMotivoBanInput é tratado pelo botão de banir/desbanir

            if (!newName) {
                editErrorDiv.textContent = 'O nome é um campo obrigatório.';
                return;
            }

            try {
                const updateData = {
                    name: newName,
                    profilePictureUrl: newProfilePictureUrl,
                };

                // Atualiza o documento no Firestore
                await db.collection('users').doc(selectedUserUid).update(updateData);
                editSuccessDiv.textContent = 'Dados do usuário atualizados com sucesso!';
                // Re-buscar para atualizar a exibição, caso os dados no Firestore tenham mudado
                fetchUserDetails(selectedUserUid);

            } catch (error) {
                console.error("Erro ao salvar alterações do usuário:", error);
                editErrorDiv.textContent = `Erro ao salvar alterações: ${error.message}`;
            }
        });

        // Botão Banir/Desbanir
        toggleBanButton.addEventListener('click', async () => {
            editErrorDiv.textContent = '';
            editSuccessDiv.textContent = '';

            if (!currentAdminUser || !(await checkAdminStatus(currentAdminUser.uid))) {
                editErrorDiv.textContent = 'Você não tem permissão de administrador para banir/desbanir.';
                return;
            }
            if (!selectedUserUid) {
                editErrorDiv.textContent = 'Nenhum usuário selecionado para banir/desbanir.';
                return;
            }

            const newBanStatus = !selectedUserIsBanned;
            let motivoBanValue = userMotivoBanInput.value.trim();

            if (newBanStatus && !motivoBanValue) { // Se estiver banindo e o motivo estiver vazio
                editErrorDiv.textContent = 'O motivo do banimento é obrigatório ao banir o usuário.';
                return;
            }

            try {
                // Chama a Cloud Function para banir/desbanir o usuário
                const toggleUserBan = functions.httpsCallable('getUserDetailsAndToggleBan');
                const result = await toggleUserBan({
                    uid: selectedUserUid,
                    action: 'toggleBan',
                    isBanned: newBanStatus,
                    motivoBan: newBanStatus ? motivoBanValue : null // Passa null para remover o campo se desbanindo
                });

                editSuccessDiv.textContent = result.data.message;
                selectedUserIsBanned = newBanStatus; // Atualiza o estado local
                toggleBanButton.textContent = selectedUserIsBanned ? 'Desbanir Usuário' : 'Banir Usuário';
                toggleBanButton.classList.toggle('red', !selectedUserIsBanned);
                userIsBannedDisplay.textContent = selectedUserIsBanned ? 'Sim' : 'Não';
                if (!newBanStatus) {
                    userMotivoBanInput.value = ''; // Limpa o motivo ao desbanir
                }

                // Re-buscar os detalhes para garantir que a UI está totalmente sincronizada com as atualizações do Auth/Firestore
                fetchUserDetails(selectedUserUid);

            } catch (error) {
                console.error("Erro ao banir/desbanir usuário:", error);
                // Exibe a mensagem de erro da Cloud Function, se disponível
                editErrorDiv.textContent = `Erro ao banir/desbanir: ${error.message}`;
            }
        });
    </script>
</body>
</html>

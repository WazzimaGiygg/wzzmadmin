<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wiki Zone Zero Mod</title>
    <link rel="icon" href="favicom.png" type="image/x-icon">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <style id="custom-app-css">
        /* Este será o local onde o CSS dos aplicativos do usuário será injetado */
    </style>
    <style>
        /* Seus estilos CSS existentes aqui */
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        .mdl-layout__content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
        }
        .page-content {
            flex-grow: 1;
        }

        /* Estilos adicionais para o recurso de notícias */
        #news-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            background-color: #3f51b5;
            color: white;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.26);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #news-button:hover {
            background-color: #303f9f;
        }

        .notification-badge {
            background-color: red;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.7em;
            position: absolute;
            top: 0px;
            right: 0px;
            transform: translate(50%, -50%);
            min-width: 15px; /* Garante que o círculo seja visível mesmo com um único dígito */
            text-align: center;
        }

        #news-center-popup {
            display: none; /* Escondido por padrão */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            max-height: 90%;
            background-color: white;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            z-index: 2000;
            overflow: hidden;
            flex-direction: column; /* Para organização do conteúdo */
        }

        #news-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: #3f51b5;
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        #news-popup-header h2 {
            margin: 0;
            font-size: 1.5em;
        }

        #close-news-popup {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            padding: 0;
            display: flex; /* Para centralizar o ícone */
            align-items: center;
            justify-content: center;
        }

        #news-popup-content {
            padding: 16px;
            overflow-y: auto; /* Adiciona scroll se o conteúdo for muito grande */
            flex-grow: 1; /* Permite que o conteúdo ocupe o espaço restante */
        }

        .news-popup-item {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            padding: 15px;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .news-popup-item:hover {
            background-color: #f0f0f0;
        }

        .news-popup-item.unread {
            border: 2px solid #3f51b5; /* Exemplo: borda azul para não lidas */
            background-color: #e8eaf6; /* Exemplo: fundo mais claro para não lidas */
            font-weight: bold;
        }

        .news-popup-item h3 {
            margin-top: 0;
            color: #333;
        }

        .news-popup-item p {
            font-size: 0.9em;
            color: #555;
            line-height: 1.5;
        }

        .news-popup-item small {
            display: block;
            margin-top: 10px;
            color: #777;
            text-align: right;
        }

        #news-popup-footer {
            padding: 10px 16px;
            background-color: #f0f0f0;
            border-top: 1px solid #ddd;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-drawer mdl-layout--fixed-header">
        <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
                <span class="mdl-layout-title">Wiki Zone Zero Mod</span>
                <div class="mdl-layout-spacer"></div>
                <nav class="mdl-navigation mdl-layout--large-screen-only">
                    <div id="user-info-container" style="display: none; align-items: center; margin-right: 15px;">
                        <img id="user-profile-pic" src="" alt="Foto de Perfil" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; display: none;">
                        <span id="user-info" style="font-size: 0.9em; color: #fff; margin-right: 15px;"></span>
                        <button id="google-apps-button" class="mdl-button mdl-js-button mdl-button--icon" style="color: white; display: none;">
                            <i class="material-icons">apps</i>
                        </button>
                        <div id="google-apps-popup" class="mdl-shadow--2dp" style="display: none; position: absolute; top: 50px; right: 0; background-color: white; padding: 10px; border-radius: 8px; width: 250px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
                            <h4 style="margin-top: 0; text-align: center;">Meus Aplicativos</h4>
                            <div id="app-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                                </div>
                        </div>
                        <button id="logout-button" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent" style="display: none;">Sair</button>
                    </div>
                    <button id="login-google" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored" style="margin-right: 10px;">Login Google</button>
                    <button id="login-github" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">Login GitHub</button>
                </nav>
            </div>
        </header>
        <div class="mdl-layout__drawer">
            <span class="mdl-layout-title">Navegação</span>
            <nav class="mdl-navigation">





                <a class="mdl-navigation__link" href="./recepcao.html">Página Inicial</a>
                <a class="mdl-navigation__link" href="./admintools/editordeartigos.html">Adicionar Artigo</a>
                <a class="mdl-navigation__link" href="./register-material.html">Registrar Matéria</a>
                <a class="mdl-navigation__link" href="conhecawazzimagiygg.html">Conheça WazzimaGiygg</a>
                <a class="mdl-navigation__link" href="./admintools/cadastrarprofessor.html">Cadastrar Professor</a>
                <a class="mdl-navigation__link" href="./detalhes_cliente/">Procurar informações sobre Cliente</a>
                <a class="mdl-navigation__link" href="./admintools/editordenoticias.html">Adicionar Noticia</a>
                <a class="mdl-navigation__link" href="./administrarcustos/">Administrar Custos</a>
                <a class="mdl-navigation__link" href="./admintools/configuracoes.html">Configurações</a>
                <a class="mdl-navigation__link" href="./admintools/estatisticas.html">Estatísticas</a>
                <a class="mdl-navigation__link" href="./admintools/pageadmin.html">Página Administradora</a>


                <a class="mdl-navigation__link" href="#" onclick="loadPage('POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf', false)">Regras</a>
                </nav>
        </div>
        <main class="mdl-layout__content">
            <div class="page-content">
                <iframe id="content-iframe" src="recepcao.html" frameborder="0" style="width: 100%; height: 100%; border: none;"></iframe>
                <div id="access-denied-message" style="display: none; text-align: center; padding: 20px; color: red;">
                    <h3>Acesso Negado</h3>
                    <p>Você precisa estar logado para acessar esta página.</p>
                </div>
                <div id="banned-message" style="display: none; text-align: center; padding: 20px; color: red;">
                    <h3>Sua conta foi banida</h3>
                    <p>Você não tem permissão para acessar esta página. Entre em contato com o suporte para mais informações.</p>
                </div>
            </div>
        </main>
    </div>

    <button id="news-button" class="mdl-button mdl-js-button mdl-button--fab mdl-button--colored" style="display: none;">
        <i class="material-icons">notifications_active</i>
        <span class="notification-badge" style="display: none;">0</span> </button>

    <div id="news-center-popup">
        <div id="news-popup-header">
            <h2>Últimas Notícias</h2>
            <button id="close-news-popup"><i class="material-icons">close</i></button>
        </div>
        <div id="news-popup-content">
            <p>Carregando últimas notícias...</p>
        </div>
        <div id="news-popup-footer">
            <button id="view-all-news-button" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
                Ver Todas as Notícias
            </button>
        </div>
    </div>

    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>

    <script type="text/javascript">
        // --- Configuração do Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0", // Use sua própria chave!
            authDomain: "wzzm-ce3fc.firebaseapp.com",
            projectId: "wzzm-ce3fc",
            storageBucket: "wzzm-ce3fc.appspot.com",
            messagingSenderId: "249427877153",
            appId: "1:249427877153:web:0e4297294794a5aadeb260",
            measurementId: "G-PLKNZNFCQ8"
        };

        // Inicialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        firebase.analytics();

        // Variáveis globais para estado do usuário
        let currentUser = null;
        let isCurrentUserBanned = false;
        let unsubscribeNewsListener = null;
        let unsubscribeReadNewsListener = null;

        // Referências aos elementos do DOM
        const newsButton = document.getElementById('news-button');
        const newsCenterPopup = document.getElementById('news-center-popup');
        const closeNewsPopup = document.getElementById('close-news-popup'); // ID no HTML é 'close-news-popup'
        const newsPopupContent = document.getElementById('news-popup-content');
        const notificationBadge = newsButton.querySelector('.notification-badge');
        const viewAllNewsButton = document.getElementById('view-all-news-button'); // Novo botão

        // --- Funções Auxiliares ---
        function loadPage(src, requiresAuth = false) {
            const contentFrame = document.getElementById('content-iframe'); // ID correto do iframe
            const accessDeniedMessage = document.getElementById('access-denied-message');
            const bannedMessage = document.getElementById('banned-message');

            // Fecha o popup de notícias se estiver aberto ao navegar para uma nova página
            if (newsCenterPopup && newsCenterPopup.style.display === 'flex') {
                hideNewsPopup();
            }

            // Verifica se o usuário está banido
            if (isCurrentUserBanned && src !== 'recepcao.html' && src !== 'POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf') { // Permite ver recepcao e políticas mesmo banido
                contentFrame.style.display = 'none';
                accessDeniedMessage.style.display = 'none';
                bannedMessage.style.display = 'block';
                return;
            }

            // Verifica se a página requer autenticação e o usuário não está logado
            if (requiresAuth && !currentUser) {
                contentFrame.style.display = 'none';
                bannedMessage.style.display = 'none';
                accessDeniedMessage.style.display = 'block';
                return;
            }

            // Se não houver restrição, carrega a página
            contentFrame.style.display = 'block';
            accessDeniedMessage.style.display = 'none';
            bannedMessage.style.display = 'none';
            contentFrame.src = src;
        }

        // Função para ativar/desativar links de navegação com base no status de login
        function setNavLinksEnabled(enabled) {
            const navLinks = document.querySelectorAll('.mdl-navigation__link[data-requires-auth="true"]');
            navLinks.forEach(link => {
                if (enabled) {
                    link.style.pointerEvents = 'auto';
                    link.style.color = '#424242'; // Cor padrão
                } else {
                    link.style.pointerEvents = 'none';
                    link.style.color = '#9e9e9e'; // Cor para desabilitado
                }
            });
        }

        // Função para criar/atualizar o documento do perfil do usuário no Firestore
        async function createUserProfileDocument(user) {
            if (!user) return;

            const userRef = firestore.doc(`users/${user.uid}`);
            const snapshot = await userRef.get();

            if (!snapshot.exists) {
                const { displayName, email, photoURL } = user;
                const createdAt = firebase.firestore.FieldValue.serverTimestamp(); // Usar timestamp do servidor

                try {
                    await userRef.set({
                        displayName: displayName || email, // Usar email se display name não estiver disponível
                        email,
                        photoURL: photoURL || '',
                        createdAt,
                        isAdmin: false, // Define como false por padrão
                        isBan: false // Define como false por padrão
                    });
                    console.log("Perfil do usuário criado no Firestore.");
                } catch (error) {
                    console.error("Erro ao criar perfil do usuário:", error);
                }
            }
        }

        // Função para carregar e aplicar CSS de aplicativos específicos do usuário
        async function loadAndApplyUserAppsCSS(userId) {
            const customAppCssStyleTag = document.getElementById('custom-app-css');
            if (!customAppCssStyleTag) return;

            try {
                const userAppsSnapshot = await firestore.collection('userApps').doc(userId).get();
                if (userAppsSnapshot.exists) {
                    const appData = userAppsSnapshot.data();
                    let cssContent = '';
                    if (appData && appData.apps) {
                        appData.apps.forEach(app => {
                            if (app.css) {
                                cssContent += app.css + '\n';
                            }
                        });
                    }
                    customAppCssStyleTag.innerHTML = cssContent;
                } else {
                    customAppCssStyleTag.innerHTML = ''; // Limpa se não houver apps
                }
            } catch (error) {
                console.error("Erro ao carregar CSS de aplicativos do usuário:", error);
                customAppCssStyleTag.innerHTML = '';
            }
        }

        // --- FUNÇÕES PARA O POPUP DE NOTÍCIAS ---
        function showNewsPopup() {
            if (newsCenterPopup) {
                newsCenterPopup.style.display = 'flex';
                loadNewsForPopup(); // Carrega notícias quando o popup é mostrado
            }
        }

        function hideNewsPopup() {
            if (newsCenterPopup) {
                newsCenterPopup.style.display = 'none';
            }
        }

        // Função para carregar e exibir notícias no popup
        async function loadNewsForPopup() {
            newsPopupContent.innerHTML = '<p>Carregando últimas notícias...</p>';
            if (!currentUser) {
                newsPopupContent.innerHTML = '<p>Faça login para ver suas notícias personalizadas.</p>';
                return;
            }

            try {
                const newsSnapshot = await firestore.collection('news')
                    .orderBy('publishDate', 'desc') // Assume um campo 'publishDate' ou 'createdAt'
                    .limit(10) // Limita a 10 notícias no popup
                    .get();

                if (newsSnapshot.empty) {
                    newsPopupContent.innerHTML = '<p>Nenhuma notícia encontrada.</p>';
                    return;
                }

                newsPopupContent.innerHTML = ''; // Limpa o conteúdo existente

                const readNewsIds = new Set();
                const readNewsSnapshot = await firestore.collection('users').doc(currentUser.uid).collection('readNews').get();
                readNewsSnapshot.forEach(doc => readNewsIds.add(doc.id));

                newsSnapshot.forEach(doc => {
                    const news = doc.data();
                    const newsId = doc.id;
                    const isRead = readNewsIds.has(newsId);

                    const newsElement = document.createElement('div');
                    newsElement.classList.add('news-popup-item');
                    if (!isRead) {
                        newsElement.classList.add('unread'); // Adiciona classe CSS para notícias não lidas
                    }

                    const publishDate = news.publishDate ? news.publishDate.toDate() : new Date(); // Usar news.publishDate ou criar novo
                    const timeString = publishDate.toLocaleString([], {
                        year: 'numeric', month: 'numeric', day: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });

                    newsElement.innerHTML = `
                        <h3>${news.title || 'Sem Título'}</h3>
                        <p>${news.content || news.description || 'Sem conteúdo.'}</p>
                        ${news.category ? `<small>Categoria: ${news.category}</small><br>` : ''}
                        ${news.tags && news.tags.length > 0 ? `<small>Tags: ${news.tags.join(', ')}</small><br>` : ''}
                        <small>Publicado em: ${timeString}</small>
                        ${news.imageUrl ? `<img src="${news.imageUrl}" alt="Imagem da Notícia" style="max-width: 100%; height: auto; margin-top: 10px;">` : ''}
                    `;
                    newsElement.addEventListener('click', () => markNewsAsRead(currentUser.uid, newsId));
                    newsPopupContent.appendChild(newsElement);
                });

            } catch (error) {
                console.error("Erro ao buscar notícias para o popup:", error);
                newsPopupContent.innerHTML = `<p style="color: red;">Erro ao carregar notícias: ${error.message}</p>`;
            }
        }

        // Função para marcar notícia como lida
        async function markNewsAsRead(userId, newsId) {
            const readNewsDocRef = firestore.collection('users').doc(userId).collection('readNews').doc(newsId);
            try {
                await readNewsDocRef.set({ readAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
                console.log(`Notícia ${newsId} marcada como lida para o usuário ${userId}`);
                // Atualiza o contador e a lista de notícias no popup
                updateNewsNotificationCount(userId);
                loadNewsForPopup();
            } catch (error) {
                console.error("Erro ao marcar notícia como lida:", error);
            }
        }

        // Função para atualizar o contador de notícias não lidas
        async function updateNewsNotificationCount(userId) {
            if (!userId) {
                notificationBadge.style.display = 'none';
                notificationBadge.textContent = '0';
                return;
            }

            try {
                const newsSnapshot = await firestore.collection('news').get();
                const totalNewsCount = newsSnapshot.size;

                const readNewsSnapshot = await firestore.collection('users').doc(userId).collection('readNews').get();
                const readNewsCount = readNewsSnapshot.size;

                const unreadCount = totalNewsCount - readNewsCount;

                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.style.display = 'block'; // Mostra o badge
                } else {
                    notificationBadge.style.display = 'none'; // Esconde o badge
                    notificationBadge.textContent = '0';
                }
            } catch (error) {
                console.error("Erro ao atualizar contador de notícias:", error);
                notificationBadge.style.display = 'none';
                notificationBadge.textContent = '0';
            }
        }

        // --- Funções de Autenticação (EXISTENTES) ---
        const providerGoogle = new firebase.auth.GoogleAuthProvider();
        const providerGitHub = new firebase.auth.GithubAuthProvider();

        document.getElementById('login-google').addEventListener('click', () => {
            auth.signInWithPopup(providerGoogle)
                .catch(error => {
                    console.error("Erro no login com Google:", error);
                });
        });

        document.getElementById('login-github').addEventListener('click', () => {
            auth.signInWithPopup(providerGitHub)
                .catch(error => {
                    console.error("Erro no login com GitHub:", error);
                });
        });

        function handleLogout() {
            auth.signOut().then(() => {
                console.log("Usuário deslogado.");
            }).catch((error) => {
                console.error("Erro ao deslogar:", error);
            });
        }
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', handleLogout);
        }

        // --- Gerenciamento de Estado de Autenticação ---
        auth.onAuthStateChanged(async (user) => {
            currentUser = user; // Define o currentUser globalmente
            const userInfo = document.getElementById('user-info');
            const loginGoogleButton = document.getElementById('login-google');
            const loginGitHubButton = document.getElementById('login-github');
            const logoutButton = document.getElementById('logout-button');
            const userProfilePic = document.getElementById('user-profile-pic');
            const googleAppsButton = document.getElementById('google-apps-button');
            const userInfoContainer = document.getElementById('user-info-container');
            const googleAppsPopup = document.getElementById('google-apps-popup');
            const customAppCssStyleTag = document.getElementById('custom-app-css');
            const contentFrame = document.getElementById('content-iframe'); // ID correto do iframe
            const accessDeniedMessage = document.getElementById('access-denied-message');
            const bannedMessage = document.getElementById('banned-message');
            const newsButton = document.getElementById('news-button');
            const newsCenterPopup = document.getElementById('news-center-popup');


            if (user) {
                if (userInfo) userInfo.textContent = `Olá, ${user.displayName || user.email}!`;
                if (loginGoogleButton) loginGoogleButton.style.display = 'none';
                if (loginGitHubButton) loginGitHubButton.style.display = 'none';

                if (user.photoURL) {
                    if (userProfilePic) {
                        userProfilePic.src = user.photoURL;
                        userProfilePic.style.display = 'inline-block';
                    }
                } else {
                    if (userProfilePic) userProfilePic.style.display = 'none';
                }
                if (googleAppsButton) googleAppsButton.style.display = 'inline-block';
                if (userInfoContainer) userInfoContainer.style.display = 'flex';

                await createUserProfileDocument(user);

                let isUserBanned = false;

                try {
                    const userProfileRef = firestore.collection('users').doc(user.uid);
                    const doc = await userProfileRef.get();

                    if (doc.exists && doc.data()) {
                        isUserBanned = doc.data().isBan || false;
                    }
                } catch (error) {
                    console.error("Erro ao verificar perfil de usuário ou status de banimento:", error);
                    isUserBanned = false;
                }

                isCurrentUserBanned = isUserBanned;
                if (isUserBanned) {
                    console.warn(`Usuário ${user.uid} está banido.`);
                    setNavLinksEnabled(false);
                    if (logoutButton) {
                        logoutButton.style.display = 'none';
                        logoutButton.removeEventListener('click', handleLogout);
                    }
                    loadPage('recepcao.html', false);
                    if (bannedMessage) bannedMessage.style.display = 'block';
                    if (contentFrame) contentFrame.style.display = 'none';
                    if (googleAppsButton) {
                        googleAppsButton.style.pointerEvents = 'none';
                        googleAppsButton.style.opacity = '0.6';
                    }
                    if (googleAppsPopup) googleAppsPopup.style.display = 'none';
                    if (newsButton) newsButton.style.display = 'none';
                    if (newsCenterPopup) newsCenterPopup.style.display = 'none';
                } else { // User is not banned
                    if (logoutButton) logoutButton.style.display = 'inline-block';
                    setNavLinksEnabled(true); // Enable all links if not banned
                    if (bannedMessage) bannedMessage.style.display = 'none';
                    if (contentFrame) contentFrame.style.display = 'block';
                    if (accessDeniedMessage) accessDeniedMessage.style.display = 'none';
                    if (googleAppsButton) {
                        googleAppsButton.style.pointerEvents = 'auto';
                        googleAppsButton.style.opacity = '1';
                    }
                    if (newsButton) newsButton.style.display = 'inline-block';

                    await loadAndApplyUserAppsCSS(user.uid);

                    // Adicionar ouvintes em tempo real para notícias e status de leitura
                    if (unsubscribeNewsListener) {
                        unsubscribeNewsListener(); // Desinscreve o ouvinte anterior
                    }
                    unsubscribeNewsListener = firestore.collection('news').onSnapshot(() => {
                        updateNewsNotificationCount(user.uid);
                        if (newsCenterPopup.style.display === 'flex') {
                            loadNewsForPopup();
                        }
                    }, error => console.error("Erro ao ouvir notícias:", error));

                    if (unsubscribeReadNewsListener) {
                        unsubscribeReadNewsListener(); // Desinscreve o ouvinte anterior
                    }
                    unsubscribeReadNewsListener = firestore.collection('users').doc(user.uid).collection('readNews').onSnapshot(() => {
                        updateNewsNotificationCount(user.uid);
                        if (newsCenterPopup.style.display === 'flex') {
                            loadNewsForPopup();
                        }
                    }, error => console.error("Erro ao ouvir status de leitura:", error));

                    // Carrega o contador inicial de notificações ao iniciar
                    updateNewsNotificationCount(user.uid);
                }

            } else { // Usuário deslogado
                currentUser = null;
                if (userInfo) userInfo.textContent = '';
                if (loginGoogleButton) loginGoogleButton.style.display = 'inline-block';
                if (loginGitHubButton) loginGitHubButton.style.display = 'inline-block';
                if (logoutButton) logoutButton.style.display = 'none';
                isCurrentUserBanned = false;
                if (bannedMessage) bannedMessage.style.display = 'none';
                setNavLinksEnabled(false);
                loadPage('recepcao.html', false);
                if (userProfilePic) {
                    userProfilePic.style.display = 'none';
                    userProfilePic.src = '';
                }
                if (googleAppsButton) googleAppsButton.style.display = 'none';
                if (userInfoContainer) userInfoContainer.style.display = 'none';
                if (googleAppsPopup) googleAppsPopup.style.display = 'none';
                if (customAppCssStyleTag) customAppCssStyleTag.innerHTML = '';
                if (contentFrame) contentFrame.style.display = 'block';
                if (accessDeniedMessage) accessDeniedMessage.style.display = 'none';
                if (newsButton) newsButton.style.display = 'none';
                if (newsCenterPopup) newsCenterPopup.style.display = 'none';

                hideNewsPopup();

                // Desinscreve os ouvintes quando o usuário desloga
                if (unsubscribeNewsListener) {
                    unsubscribeNewsListener();
                    unsubscribeNewsListener = null;
                }
                if (unsubscribeReadNewsListener) {
                    unsubscribeReadNewsListener();
                    unsubscribeReadNewsListener = null;
                }
                notificationBadge.style.display = 'none'; // Garante que o badge esteja oculto
                notificationBadge.textContent = '0';
            }
            if (componentHandler) {
                componentHandler.upgradeDom();
            }
        });

        // --- Event Listeners DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            const googleAppsButton = document.getElementById('google-apps-button');
            const googleAppsPopup = document.getElementById('google-apps-popup');
            const navLinks = document.querySelectorAll('.mdl-navigation__link');

            // Get references for news popup elements
            const newsButton = document.getElementById('news-button');
            const newsCenterPopup = document.getElementById('news-center-popup');
            const closeNewsPopup = document.getElementById('close-news-popup'); // ID correto
            const viewAllNewsButton = document.getElementById('view-all-news-button');


            // --- Adicionar Event Listeners ---

            // Botão Google Apps (mantido)
            if (googleAppsButton) {
                googleAppsButton.addEventListener('click', (event) => {
                    event.stopPropagation(); // Evita que o clique se propague para o document
                    if (googleAppsPopup.style.display === 'block') {
                        googleAppsPopup.style.display = 'none';
                    } else {
                        googleAppsPopup.style.display = 'block';
                        // Carregar apps dinamicamente
                        const appGrid = document.getElementById('app-grid');
                        appGrid.innerHTML = '<p>Carregando aplicativos...</p>';
                        if (currentUser) {
                            firestore.collection('userApps').doc(currentUser.uid).get()
                                .then(doc => {
                                    if (doc.exists && doc.data() && doc.data().apps) {
                                        appGrid.innerHTML = ''; // Limpa o conteúdo
                                        doc.data().apps.forEach(app => {
                                            const appItem = document.createElement('div');
                                            appItem.classList.add('app-item');
                                            appItem.innerHTML = `
                                                <img src="${app.iconUrl}" alt="${app.name}">
                                                <span>${app.name}</span>
                                            `;
                                            appItem.addEventListener('click', () => {
                                                loadPage(app.url, app.requiresAuth || false);
                                                googleAppsPopup.style.display = 'none'; // Fecha o popup
                                            });
                                            appGrid.appendChild(appItem);
                                        });
                                    } else {
                                        appGrid.innerHTML = '<p>Nenhum aplicativo encontrado.</p>';
                                    }
                                })
                                .catch(error => {
                                    console.error("Erro ao carregar aplicativos:", error);
                                    appGrid.innerHTML = '<p>Erro ao carregar aplicativos.</p>';
                                });
                        } else {
                            appGrid.innerHTML = '<p>Faça login para ver seus aplicativos.</p>';
                        }
                    }
                });
            }

            // Event Listeners for News Button and Popup (mantidos e atualizados)
            if (newsButton) {
                newsButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    if (newsCenterPopup.style.display === 'flex') {
                        hideNewsPopup();
                    } else {
                        showNewsPopup();
                    }
                });
            }

            if (closeNewsPopup) { // Usar o ID correto
                closeNewsPopup.addEventListener('click', () => {
                    hideNewsPopup();
                });
            }

            if (viewAllNewsButton) {
                viewAllNewsButton.addEventListener('click', () => {
                    loadPage('visualizarnoticias.html', false); // Carrega a página completa de notícias
                    hideNewsPopup(); // Esconde o popup
                });
            }

            // Listener global para fechar popups ao clicar fora (ajustado)
            document.addEventListener('click', (event) => {
                // Fecha o popup de apps se clicar fora dele
                if (googleAppsPopup && googleAppsPopup.style.display === 'block' &&
                    !googleAppsButton.contains(event.target) &&
                    !googleAppsPopup.contains(event.target)) {
                    googleAppsPopup.style.display = 'none';
                }

                // Fecha o popup de notícias se clicar fora dele
                if (newsCenterPopup && newsCenterPopup.style.display === 'flex' &&
                    !newsButton.contains(event.target) &&
                    !newsCenterPopup.contains(event.target)) {
                    newsCenterPopup.style.display = 'none';
                }
            });

            // Adiciona event listener para links de navegação no drawer (ajustado)
            navLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    // Previne o comportamento padrão do link (evita que o href="#" recarregue a página)
                    event.preventDefault();

                    // Obtém o src da página do atributo 'data-page-src'
                    let actualPageSrc = this.getAttribute('data-page-src');

                    // Obtém o requisito de autenticação do atributo 'data-requires-auth'
                    // Ele será 'true' se o atributo existir e for 'true', caso contrário, 'false'.
                    let requiresAuth = this.getAttribute('data-requires-auth') === 'true';

                    // === NOVAS CONDIÇÕES PARA LINKS QUE NÃO TÊM data-page-src (como 'Regras') ===
                    // Se o data-page-src não estiver definido, tente extrair do onclick como fallback
                    if (!actualPageSrc) {
                        const onclickAttr = this.getAttribute('onclick');
                        if (onclickAttr && onclickAttr.includes("loadPage(")) {
                            const match = onclickAttr.match(/loadPage\('([^']*)', (true|false)\)/);
                            if (match) {
                                actualPageSrc = match[1];
                                requiresAuth = match[2] === 'true';
                            }
                        }
                    }
                    // ===========================================================================

                    // Se por algum motivo ainda não tivermos um src, pare a execução
                    if (!actualPageSrc) {
                        console.warn('Nenhum src de página encontrado para o link:', this);
                        return;
                    }

                    // Verifica se o usuário está banido (Mantenha o seu código de lógica aqui)
                    if (isCurrentUserBanned && !actualPageSrc.includes('POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf')) {
                        return; // O preventDefault já foi chamado
                    }

                    if (this.classList.contains('disabled') && !actualPageSrc.includes('POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf')) {
                        return; // O preventDefault já foi chamado
                    }

                    if (actualPageSrc.includes('POL%C3%8DTICAS%20GERAIS%20DO%20WIKI%20ZONE%20ZERO%20MOD.pdf')) {
                        // Para PDFs ou outros arquivos que o navegador deve lidar, não chame loadPage
                        // e permita que o href padrão funcione (se houver, mas aqui é #).
                        // Se for um PDF para o iframe, mantenha loadPage.
                        // Dado o seu código anterior que permitia a abertura de PDFs, vamos mantê-lo.
                        // Se você quiser que PDFs abram em uma nova aba, você precisaria de um 'target="_blank"' no link
                        // ou um tratamento JS diferente.
                    }

                    loadPage(actualPageSrc, requiresAuth); // Chama a função para carregar a página
                    
                    // Fecha o drawer do MDL se estiver aberto
                    if (document.querySelector('.mdl-layout__drawer.is-visible')) {
                        document.querySelector('.mdl-layout__obfuscator').classList.remove('is-visible');
                        document.querySelector('.mdl-layout__drawer').classList.remove('is-visible');
                    }
                });
            });

            // Inicializa componentes MDL
            if (componentHandler) {
                componentHandler.upgradeDom();
            }
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>WZZM WIKI ZONE ZERO MOD - Artigos e Matérias</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Estilos para ocultar/mostrar elementos */
    .hidden {
      display: none;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen py-8">
  <div class="max-w-6xl mx-auto px-4">
    <h1 class="text-2xl font-semibold text-center text-gray-800 mb-8">Matérias de Graduação: Pesquisa e Análise de Dados</h1>

    <div id="auth-section" class="max-w-md mx-auto bg-white rounded-lg shadow p-6 mb-8 text-center">
      <h2 class="text-xl font-semibold text-gray-700 mb-4" id="auth-title"></h2>
      <div id="auth-buttons" class="flex flex-col items-center gap-4">
        <button
          type="button"
          id="google-login-btn"
          class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full max-w-xs"
        >
          Entrar com Google
        </button>
        <button
          type="button"
          id="logout-btn"
          class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline hidden w-full max-w-xs"
        >
          Sair
        </button>
      </div>
      <p id="auth-message" class="mt-4 text-sm"></p>
      <div id="user-status" class="mt-4 text-gray-700 text-sm"></div>
    </div>

    <div id="add-article-section" class="max-w-md mx-auto bg-white rounded-lg shadow p-6 mt-8 hidden">
      <h2 class="text-xl font-semibold text-gray-700 mb-4">Adicionar Novo Artigo</h2>
      <form id="add-article-form">
        <div class="mb-4">
          <label for="newTitulo" class="block text-gray-700 text-sm font-bold mb-2">Título:</label>
          <input
            type="text"
            id="newTitulo"
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
            required
          />
        </div>
        <div class="mb-4">
          <label for="newDescricao" class="block text-gray-700 text-sm font-bold mb-2">Descrição:</label>
          <textarea
            id="newDescricao"
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
            rows="3"
            required
          ></textarea>
        </div>
        <div class="mb-4">
          <label for="newLink" class="block text-gray-700 text-sm font-bold mb-2">Link (URL):</label>
          <input
            type="url"
            id="newLink"
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
            required
          />
        </div>
        <div class="mb-4">
          <label for="newCategoria" class="block text-gray-700 text-sm font-bold mb-2">Categoria:</label>
          <input
            type="text"
            id="newCategoria"
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
            required
          />
        </div>
        <div class="mb-4">
          <label for="newAcesso" class="block text-gray-700 text-sm font-bold mb-2">Acesso:</label>
          <select
            id="newAcesso"
            class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
          >
            <option value="publico">Público</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button
          type="submit"
          class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline"
        >
          Adicionar Artigo
        </button>
      </form>
      <p id="form-message" class="mt-4 text-sm"></p>
    </div>

    <div id="content-sections" class="mt-8">
      <p>Carregando conteúdo...</p>
    </div>

  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-analytics-compat.js"></script>
  <script>
    // 1. Sua configuração do Firebase (copie do seu console Firebase)
    const firebaseConfig = {
      apiKey: "AIzaSyB9GkSqTIZ0kbVsba_WOdQeVAETrF9qna0",
      authDomain: "wzzm-ce3fc.firebaseapp.com",
      projectId: "wzzm-ce3fc",
      storageBucket: "wzzm-ce3fc.firebasestorage.app",
      messagingSenderId: "249427877153",
      appId: "1:249427877153:web:0e4297294794a5aadeb260",
      measurementId: "G-PLKNZNFCQ8" // Opcional: só se você estiver usando Firebase Analytics
    };

    // Inicialize o Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const analytics = firebase.analytics(); // Inicializa o Analytics se measurementId estiver na config

    // Referências aos elementos HTML
    const authTitle = document.getElementById('auth-title');
    const googleLoginBtn = document.getElementById('google-login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const authMessage = document.getElementById('auth-message');
    const userStatusDiv = document.getElementById('user-status');
    const addArticleSection = document.getElementById('add-article-section');
    const addArticleForm = document.getElementById('add-article-form');
    const formMessage = document.getElementById('form-message');
    const contentSectionsDiv = document.getElementById('content-sections');

    let isAdminUser = false; // Flag para verificar se o usuário é admin

    // 2. Função para verificar se um usuário é administrador
    async function checkAdminStatus(uid) {
      if (!uid) {
        isAdminUser = false;
        return false;
      }
      try {
        const adminDoc = await db.collection('admins').doc(uid).get();
        isAdminUser = adminDoc.exists; // Se o documento existir, é admin
        return isAdminUser;
      } catch (error) {
        console.error("Erro ao verificar status de administrador:", error);
        isAdminUser = false;
        return false;
      }
    }

    // 3. Listener para mudanças no estado de autenticação
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // Usuário logado
        authTitle.textContent = `Bem-vindo(a), ${user.displayName || user.email}!`;
        googleLoginBtn.classList.add('hidden'); // Esconde botão de login
        logoutBtn.classList.remove('hidden'); // Mostra botão de logout
        authMessage.textContent = '';
        userStatusDiv.textContent = `Logado como: ${user.email} (UID: ${user.uid})`;

        // Verificar se é admin
        const isAdmin = await checkAdminStatus(user.uid);
        if (isAdmin) {
          userStatusDiv.textContent += ' (Administrador)';
          addArticleSection.classList.remove('hidden'); // Mostrar formulário de adição
        } else {
          userStatusDiv.textContent += ' (Não Administrador)';
          addArticleSection.classList.add('hidden'); // Esconder formulário de adição
        }

        // Carregar conteúdo após o login
        loadContent();

      } else {
        // Usuário deslogado
        authTitle.textContent = 'Faça Login ou Registre-se';
        googleLoginBtn.classList.remove('hidden'); // Mostra botão de login
        logoutBtn.classList.add('hidden'); // Esconde botão de logout
        authMessage.textContent = '';
        userStatusDiv.textContent = 'Nenhum usuário logado.';
        addArticleSection.classList.add('hidden'); // Esconder formulário de adição

        // Recarregar conteúdo se houver mudança de acesso (ex: de admin para deslogado)
        loadContent();
      }
    });

    // 4. Lógica de Login com Google
    googleLoginBtn.addEventListener('click', async () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      authMessage.textContent = ''; // Limpa mensagens anteriores

      try {
        await auth.signInWithPopup(provider);
        authMessage.textContent = 'Login com Google bem-sucedido!';
        authMessage.className = 'mt-4 text-sm text-green-600';
      } catch (error) {
        console.error("Erro no login com Google:", error);
        authMessage.textContent = `Erro ao fazer login com Google: ${error.message}`;
        authMessage.className = 'mt-4 text-sm text-red-600';
      }
    });

    // 5. Lógica de Logout
    logoutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
        authMessage.textContent = 'Você foi desconectado.';
        authMessage.className = 'mt-4 text-sm text-green-600';
        // onAuthStateChanged cuidará da atualização da UI
      } catch (error) {
        console.error("Erro ao sair:", error);
        authMessage.textContent = `Erro ao sair: ${error.message}`;
        authMessage.className = 'mt-4 text-sm text-red-600';
      }
    });


    // 6. Lógica de Adição de Artigos (APENAS PARA ADMINS)
    if (addArticleForm) {
      addArticleForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Verificar se o usuário atual é um administrador
        if (!isAdminUser || !auth.currentUser) {
          formMessage.textContent = 'Apenas administradores podem adicionar artigos.';
          formMessage.className = 'mt-4 text-sm text-red-600';
          return;
        }

        const titulo = document.getElementById('newTitulo').value;
        const descricao = document.getElementById('newDescricao').value;
        const link = document.getElementById('newLink').value;
        const categoria = document.getElementById('newCategoria').value;
        const acesso = document.getElementById('newAcesso').value; // 'publico' ou 'admin'

        const newArticle = {
          titulo: titulo,
          descricao: descricao,
          link: link,
          categoria: categoria,
          acesso: acesso,
          authorUid: auth.currentUser.uid, // O UID do usuário admin logado
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
          await db.collection('articles').add(newArticle);

          formMessage.textContent = 'Artigo adicionado com sucesso!';
          formMessage.className = 'mt-4 text-sm text-green-600';
          addArticleForm.reset();
          loadContent(); // Recarregar a lista de artigos
        } catch (error) {
          console.error('Erro ao adicionar artigo:', error);
          formMessage.textContent = `Erro ao adicionar artigo: ${error.message}`;
          formMessage.className = 'mt-4 text-sm text-red-600';
        }
      });
    }

    // 7. Lógica de Carregamento de Conteúdo (Filtrado por Acesso)
    async function loadContent() {
      contentSectionsDiv.innerHTML = '<p>Carregando conteúdo...</p>';

      try {
        let articlesQuery = db.collection('articles');

        // Se o usuário não for admin, ou não estiver logado,
        // apenas carrega artigos com 'acesso: publico'.
        // Se for admin, carrega todos.
        // A regra do Firestore também fará essa validação no backend,
        // mas é bom ter o filtro aqui para otimizar o frontend.
        if (!isAdminUser) {
            articlesQuery = articlesQuery.where('acesso', '==', 'publico');
        }

        const snapshot = await articlesQuery.get();

        if (snapshot.empty) {
          contentSectionsDiv.innerHTML = '<p>Nenhum artigo encontrado.</p>';
          return;
        }

        const materias = [];
        snapshot.forEach(doc => {
          materias.push({ id: doc.id, ...doc.data() });
        });

        const categorias = {};
        materias.forEach(materia => {
          if (!categorias[materia.categoria]) {
            categorias[materia.categoria] = [];
          }
          categorias[materia.categoria].push(materia);
        });

        contentSectionsDiv.innerHTML = '';

        for (const categoria in categorias) {
          const section = document.createElement('section');
          section.className = 'mb-10';
          section.innerHTML = `
              <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">${categoria}</h2>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="${categoria.replace(/\s+/g, '-').toLowerCase()}-container">
              </div>
            `;
          contentSectionsDiv.appendChild(section);

          const container = section.querySelector(`#${categoria.replace(/\s+/g, '-').toLowerCase()}-container`);

          categorias[categoria].forEach(materia => {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-lg shadow p-4';
            div.innerHTML = `
                <h3 class="font-semibold text-gray-800">${materia.titulo}</h3>
                <p class="text-sm text-gray-600 mt-1">${materia.descricao}</p>
                <a href="${materia.link}" class="text-blue-600 text-sm font-semibold hover:underline mt-2 inline-block">Ver mais</a>
              `;
            container.appendChild(div);
          });
        }

      } catch (error) {
        console.error("Erro ao carregar conteúdo do Firestore:", error);
        contentSectionsDiv.innerHTML = `<p class="text-red-500">Erro ao carregar o conteúdo: ${error.message}. Verifique suas regras de segurança do Firestore e a autenticação.</p>`;
      }
    }

    // Iniciar carregamento de conteúdo ao carregar a página (o onAuthStateChanged também chamará)
    window.addEventListener('load', loadContent);
  </script>
</body>
</html>
